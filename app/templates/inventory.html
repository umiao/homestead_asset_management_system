{% extends "base.html" %}

{% block title %}Inventory - PantryPilot{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem; font-size: 2rem; font-weight: 700;">Inventory Management</h1>

<!-- Search and Filters -->
<div class="card">
    <div class="search-bar">
        <input type="text" id="search-input" class="search-input" placeholder="üîç Search items...">
        <select id="category-filter" class="form-select" style="width: 200px;">
            <option value="">All Categories</option>
        </select>
        <select id="expiry-filter" class="form-select" style="width: 200px;">
            <option value="">All Status</option>
            <option value="fresh">Fresh</option>
            <option value="expiring_soon">Expiring Soon</option>
            <option value="expired">Expired</option>
            <option value="no_expiry">No Expiry</option>
        </select>
        <button onclick="searchItems()" class="btn btn-primary">Search</button>
        <button onclick="showAddModal()" class="btn btn-success">‚ûï Add Item</button>
        <button onclick="deleteSelected()" class="btn btn-danger" id="delete-selected-btn" style="display: none;">üóëÔ∏è Delete Selected (<span id="selected-count">0</span>)</button>
    </div>
</div>

<!-- Two Column Layout -->
<div style="display: grid; grid-template-columns: 300px 1fr; gap: 1.5rem;">
    <!-- Location Hierarchy Sidebar -->
    <div class="card" style="height: fit-content; position: sticky; top: 100px;">
        <div class="card-header">
            <h3 class="card-title">Locations</h3>
        </div>
        <div id="location-tree">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Items List -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Items</h3>
            <span id="item-count" style="color: var(--text-secondary);">0 items</span>
        </div>
        <div id="items-container">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<!-- Add/Edit Item Modal -->
<div id="item-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 600px; width: 90%; margin: 2rem; max-height: 90vh; overflow-y: auto;">
        <div class="card-header">
            <h3 class="card-title" id="modal-title">Add New Item</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
        </div>
        <form id="item-form" onsubmit="saveItem(event)">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="item-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <input type="text" id="item-category" class="form-input" list="category-list" required>
                    <datalist id="category-list"></datalist>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Quantity *</label>
                    <input type="number" id="item-quantity" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Unit *</label>
                    <select id="item-unit" class="form-select" required>
                        <option value="count">count</option>
                        <option value="kg">kg</option>
                        <option value="g">g</option>
                        <option value="liter">liter</option>
                        <option value="ml">ml</option>
                        <option value="piece">piece</option>
                        <option value="bottle">bottle</option>
                        <option value="can">can</option>
                        <option value="box">box</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Location Path *</label>
                <input type="text" id="item-location" class="form-input" placeholder="e.g., Kitchen > Fridge > Top Shelf" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Acquired Date</label>
                    <input type="date" id="item-acquired" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Expiry Date</label>
                    <input type="date" id="item-expiry" class="form-input">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea id="item-notes" class="form-textarea" rows="3"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Item</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allItems = [];
    let allLocations = [];
    let selectedLocationId = null;

    async function loadInventory() {
        try {
            // Load items
            allItems = await fetchAPI('/inventory/items?limit=1000');

            // Load locations
            allLocations = await fetchAPI('/inventory/locations');

            // Load categories
            const categories = await fetchAPI('/inventory/categories');
            populateCategoryFilter(categories);
            populateCategoryDatalist(categories);

            // Display
            displayLocationTree(allLocations);
            displayItems(allItems);

        } catch (error) {
            console.error('Error loading inventory:', error);
            showMessage('Error loading inventory', 'error');
        }
    }

    function populateCategoryFilter(categories) {
        const select = document.getElementById('category-filter');
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
        });
    }

    function populateCategoryDatalist(categories) {
        const datalist = document.getElementById('category-list');
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            datalist.appendChild(option);
        });
    }

    function displayLocationTree(locations) {
        const container = document.getElementById('location-tree');

        if (locations.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.875rem;">No locations yet</p>';
            return;
        }

        // Build tree structure
        const locationMap = {};
        const rootLocations = [];

        locations.forEach(loc => {
            locationMap[loc.id] = { ...loc, children: [] };
        });

        locations.forEach(loc => {
            if (loc.parent_id) {
                if (locationMap[loc.parent_id]) {
                    locationMap[loc.parent_id].children.push(locationMap[loc.id]);
                }
            } else {
                rootLocations.push(locationMap[loc.id]);
            }
        });

        // Render tree
        container.innerHTML = '<ul class="tree">' + renderLocationNodes(rootLocations) + '</ul>';
    }

    function renderLocationNodes(nodes) {
        return nodes.map(node => {
            const itemCount = allItems.filter(item => item.location_id === node.id).length;
            const hasChildren = node.children && node.children.length > 0;

            return `
                <li class="tree-item">
                    <div class="tree-node" onclick="selectLocation(${node.id})">
                        <span class="tree-icon">${hasChildren ? 'üìÅ' : 'üìÇ'}</span>
                        <span class="tree-label">${node.name}</span>
                        ${itemCount > 0 ? `<span class="tree-count">${itemCount}</span>` : ''}
                    </div>
                    ${hasChildren ? '<ul class="tree-children">' + renderLocationNodes(node.children) + '</ul>' : ''}
                </li>
            `;
        }).join('');
    }

    function selectLocation(locationId) {
        selectedLocationId = locationId;
        const filtered = allItems.filter(item => item.location_id === locationId);
        displayItems(filtered);
    }

    function searchItems() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const category = document.getElementById('category-filter').value;
        const expiryStatus = document.getElementById('expiry-filter').value;

        let filtered = allItems;

        if (query) {
            filtered = filtered.filter(item =>
                item.name.toLowerCase().includes(query) ||
                (item.notes && item.notes.toLowerCase().includes(query))
            );
        }

        if (category) {
            filtered = filtered.filter(item => item.category === category);
        }

        if (expiryStatus) {
            filtered = filtered.filter(item => item.expiry_status === expiryStatus);
        }

        displayItems(filtered);
    }

    function displayItems(items) {
        const container = document.getElementById('items-container');
        document.getElementById('item-count').textContent = `${items.length} items`;

        if (items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <div class="empty-state-title">No items found</div>
                    <p>Try adjusting your filters or add new items</p>
                </div>
            `;
            return;
        }

        const table = `
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                            </th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Quantity</th>
                            <th>Location</th>
                            <th>Acquired</th>
                            <th>Expiry</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => {
                            const location = allLocations.find(loc => loc.id === item.location_id);
                            return `
                                <tr>
                                    <td>
                                        <input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateSelectedCount()">
                                    </td>
                                    <td style="font-weight: 600;">${item.name}</td>
                                    <td>${item.category}</td>
                                    <td>${item.quantity} ${item.unit}</td>
                                    <td style="font-size: 0.875rem;">${location ? location.full_path : 'Unknown'}</td>
                                    <td style="font-size: 0.875rem;">${formatDate(item.acquired_date)}</td>
                                    <td style="font-size: 0.875rem;">${formatDate(item.expiry_date)}</td>
                                    <td>
                                        <span class="badge ${getExpiryBadge(item.expiry_status)}">
                                            ${getExpiryLabel(item.expiry_status)}
                                        </span>
                                    </td>
                                    <td>
                                        <button onclick="deleteItem(${item.id})" class="btn btn-danger btn-sm">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
        container.innerHTML = table;
        updateSelectedCount();
    }

    function showAddModal() {
        document.getElementById('item-modal').style.display = 'flex';
        document.getElementById('modal-title').textContent = 'Add New Item';
        document.getElementById('item-form').reset();

        // Set default acquired date to today
        document.getElementById('item-acquired').valueAsDate = new Date();
    }

    function closeModal() {
        document.getElementById('item-modal').style.display = 'none';
    }

    async function saveItem(event) {
        event.preventDefault();

        const formData = {
            name: document.getElementById('item-name').value,
            category: document.getElementById('item-category').value,
            quantity: parseFloat(document.getElementById('item-quantity').value),
            unit: document.getElementById('item-unit').value,
            location_path: document.getElementById('item-location').value,
            acquired_date: document.getElementById('item-acquired').value || null,
            expiry_date: document.getElementById('item-expiry').value || null,
            notes: document.getElementById('item-notes').value || null
        };

        try {
            await fetchAPI('/inventory/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            showMessage('Item added successfully', 'success');
            closeModal();
            loadInventory();
        } catch (error) {
            console.error('Error saving item:', error);
            showMessage('Error saving item', 'error');
        }
    }

    function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('.item-checkbox');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');
        const count = checkboxes.length;
        document.getElementById('selected-count').textContent = count;

        const deleteBtn = document.getElementById('delete-selected-btn');
        if (count > 0) {
            deleteBtn.style.display = 'inline-flex';
        } else {
            deleteBtn.style.display = 'none';
        }

        // Update select-all checkbox state
        const allCheckboxes = document.querySelectorAll('.item-checkbox');
        const selectAllCheckbox = document.getElementById('select-all');
        if (selectAllCheckbox && allCheckboxes.length > 0) {
            selectAllCheckbox.checked = count === allCheckboxes.length;
        }
    }

    async function deleteSelected() {
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');
        const itemIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (itemIds.length === 0) {
            showMessage('No items selected', 'error');
            return;
        }

        if (!confirm(`Are you sure you want to delete ${itemIds.length} item(s)?`)) {
            return;
        }

        try {
            let successCount = 0;
            let errorCount = 0;

            for (const itemId of itemIds) {
                try {
                    await fetchAPI(`/inventory/items/${itemId}`, {
                        method: 'DELETE'
                    });
                    successCount++;
                } catch (error) {
                    errorCount++;
                }
            }

            if (successCount > 0) {
                showMessage(`Successfully deleted ${successCount} item(s)`, 'success');
            }
            if (errorCount > 0) {
                showMessage(`Failed to delete ${errorCount} item(s)`, 'error');
            }

            await loadInventory();

            // Reset checkboxes and button state after reload
            setTimeout(() => {
                const selectAll = document.getElementById('select-all');
                if (selectAll) selectAll.checked = false;

                const checkboxes = document.querySelectorAll('.item-checkbox');
                checkboxes.forEach(cb => cb.checked = false);

                updateSelectedCount();  // This will hide the Delete Selected button
            }, 100);
        } catch (error) {
            console.error('Error deleting items:', error);
            showMessage('Error deleting items', 'error');
        }
    }

    async function deleteItem(itemId) {
        if (!confirm('Are you sure you want to delete this item?')) {
            return;
        }

        try {
            await fetchAPI(`/inventory/items/${itemId}`, {
                method: 'DELETE'
            });

            showMessage('Item deleted successfully', 'success');
            loadInventory();
        } catch (error) {
            console.error('Error deleting item:', error);
            showMessage('Error deleting item', 'error');
        }
    }

    // Load inventory on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadInventory();

        // Add Enter key support for search
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchItems();
            }
        });
    });

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });
</script>
{% endblock %}
